rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  // Allow both new venue-oriented categories and legacy ones during migration.
  function allowedCategories() { return ['coffeeshop','hawker','food_centre','cafe','restaurant','buffet','others','food','coffee','groceries']; }
  function allowedPayments() { return ['card', 'qr', 'cash']; }
    function validTx(data) {
      return data.amount is number
        && data.amount > 0 && data.amount < 100000
        && data.currency == 'SGD'
        && data.categoryId in allowedCategories()
        && data.paymentMethod in allowedPayments()
        && data.date is timestamp;
    }
    match /users/{uid} {
      allow read, write: if isOwner(uid);
      match /categories/{categoryId} {
        allow read, write: if isOwner(uid);
      }
      match /transactions/{txId} {
        // Reads: only ownership check
        allow get, list: if isOwner(uid);
        // Create: validate tx fields (allow client or server timestamps). Accept timestamps provided by client for personal app simplicity.
        allow create: if isOwner(uid) && validTx(request.resource.data);
        // Update: createdAt immutable, other fields valid
        allow update: if isOwner(uid)
          && validTx(request.resource.data)
          && resource.data.createdAt == request.resource.data.createdAt;
        allow delete: if isOwner(uid);
      }
      match /budgets/{budgetId} {
        allow read, write: if isOwner(uid);
      }
      // Settings / metadata (e.g., users/{uid}/meta/settings)
      match /meta/{docId} {
        allow read, write: if isOwner(uid);
      }
    }
    // Explicit duplicate meta rule at root scope (defensive, should be redundant but ensures coverage)
    match /users/{uid}/meta/{docId} {
      allow read, write: if isOwner(uid);
    }
    // Catch-all for any future simple subcollections under user (still enforces ownership).
    // More specific rules (e.g., transactions) override this due to higher specificity.
    match /users/{uid}/{document=**} {
      allow read, write: if isOwner(uid);
    }
  }
}
